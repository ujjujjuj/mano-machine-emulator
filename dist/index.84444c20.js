var e=new class{constructor(){this.key="",this.state=new Set,this.waiting=!1,document.addEventListener("keydown",this.keydown.bind(this)),document.addEventListener("keyup",this.keyup.bind(this))}onInput(e){console.log(e),this.input=e}keydown(e){const t=e.keyCode;this.state.has(t)||(this.state.add(t),this.input(t))}keyup(e){const t=e.keyCode;this.state.delete(t)}};var t=new class{constructor(e,t){this.width=e,this.height=Math.round(t/2.28),this.element=document.querySelector(".screen"),this.element.style=`width:${e}rem;height:${t}rem`,this.text="",this.blinkInterval=setInterval(this.blink.bind(this),500),this.isBlink=!1}updateText(){this.element.innerText=this.text+(this.isBlink?"|":"")}blink(){this.updateText(),this.isBlink=!this.isBlink}addText(e){if("clear"===e)return this.text="",void this.updateText();if(this.text+=String.fromCharCode(e),13===e){(this.text.match(/\r/g)?.length??0)==this.height-1&&(this.text=this.text.split("\r").slice(1).join("\r"))}this.updateText()}}(80,50);const s={pseudo:["ORG","DEC","HEX","END"],mr:["AND","ADD","LDA","STA","BUN","BSA","ISZ"],nmr:["CLA","CLE","CMA","CME","CIR","CIL","INC","SPA","SNA","SZA","SZE","HLT","INP","OUT","SKI","SKO","ION","IOF"]},i=[30720,29696,29184,28928,28800,28736,28704,28688,28680,28676,28674,28673,63488,62464,61952,61696,61568,61504];var r=new class{constructor(){}tokenize(e){e=e.trim();let t=[];for(let s of e.split("\n"))s=s.split("/")[0].trim().replaceAll(",",", ").replaceAll(/ +/g," ").split(" ").filter((e=>e.length>0)),0!==s.length&&t.push(s);return t}assemble(e){const t={},r=this.tokenize(e);let n=0;for(const e of r){let s=e[0];if("ORG"===s)n=Number("0x"+e[1]);else{if("END"===s)break;s.includes(",")&&(t[s.replace(",","")]=n),n++}}console.log("Finished first pass, symbol table is",t);const h=new ArrayBuffer(8192),a=new DataView(h);n=0;for(let e of r){if(e[0].includes(",")&&(e=e.slice(1)),s.pseudo.includes(e[0])){if("ORG"===e[0]){n=parseInt("0x"+e[1]);continue}if("END"===e[0])break;{let s;Object.keys(t).includes(e[1])?s=t[e[1]]:("HEX"===e[0]&&(Object.keys(t).includes(e[1])&&(e[1]=t[e[1]].toString(16)),e[1]="0x"+e[1]),s=Number(e[1])),s%=65536,a.setUint16(2*n,s,!1)}}else if(s.mr.includes(e[0])){let i=s.mr.indexOf(e[0])<<12;"I"===e[e.length-1]&&(i|=32768),i|=t[e[1]],a.setUint16(2*n,i,!1)}else{if(!s.nmr.includes(e[0]))throw alert(`Invalid instruction: ${e}`),`Invalid instruction: ${e}`;{let t=i[s.nmr.indexOf(e[0])];a.setUint16(2*n,t,!1)}}n++}return console.log("Finished second pass, RAM:"),h}};var n=new class{constructor(){this.reset(),this.ram=null,this.view=null}reset(){this.isRunning&&!this.isHalted||(console.log("Resetting emulator..."),this.registers={AR:0,PC:0,DR:0,AC:0,IR:0,TP:0,OUTR:0,INPR:0,SC:0},this.ff={I:0,S:0,E:0,R:0,IEN:0,FGI:0,FGO:1},this.rom&&(this.ram=this.rom.slice(0),this.view=new DataView(this.ram)),this.halted=!1,this.isRunning=!1,this.keyboardBuffer=[],this.keyboardPromiseResolver=null,this.output&&this.output("clear"))}setRam(e){this.rom=e,this.ram=e.slice(0),this.view=new DataView(this.ram)}getInput(e){this.keyboardPromiseResolver&&this.keyboardPromiseResolver(),this.ff.FGI=0,this.keyboardBuffer.push(e)}onOutput(e){this.output=e}read(e){return this.view.getUint16(2*e,!1)}write(e,t){this.view.setUint16(2*e,t,!1)}async run(){if(!this.isRunning){for(this.reset(),this.isRunning=!0;!this.halted;)await this._stepInstruction();for(let e of"\n\nFinished execution...")this.output(e.charCodeAt(0));this.isRunning=!1}}async _stepInstruction(){const e=this.read(this.registers.PC);this.registers.PC++,this.ff.I=e>>15;let t=(28672&e)>>12;if(7==t)switch(e){case 30720:this.registers.AC=0;break;case 29696:this.ff.E=0;break;case 29184:this.registers.AC=65535&~this.registers.AC;break;case 28928:this.ff.E=1&~this.ff.E;break;case 28800:this.ff.E=1&this.registers.AC,this.registers.AC>>=1,this.registers.AC|=this.ff.E<<15;break;case 28736:this.ff.E=(32768&this.registers.AC)>>15,this.registers.AC=this.registers.AC<<1&65535,this.registers.AC|=this.ff.E;break;case 28704:this.registers.AC++;break;case 28688:this.registers.AC>=0&&this.registers.PC++;break;case 28680:(32768&this.registers.AC)>0&&this.registers.PC++;break;case 28676:0===this.registers.AC&&this.registers.PC++;break;case 28674:this.ff.E||this.registers.PC++;break;case 28673:this.halted=!0;break;case 63488:0===this.keyboardBuffer.length&&await new Promise((e=>{this.keyboardPromiseResolver=e})),this.registers.AC=this.keyboardBuffer.shift(),0===this.keyboardBuffer.length&&(this.ff.FGI=1);break;case 62464:this.output(this.registers.AC);break;case 61696:1===this.ff.FGI&&this.registers.PC++;break;case 61952:1===this.ff.FGO&&this.registers.PC++;break;case 61568:this.ff.IEN=1;break;case 61504:this.ff.IEN=0;break;default:throw`Invalid opcode ${e}`}else switch(this.registers.AR=4095&e,1===this.ff.I&&(this.registers.AR=this.read(this.registers.AR)),t){case 0:this.registers.AC&=this.read(this.registers.AR);break;case 1:this.registers.AC=(this.registers.AC+this.read(this.registers.AR))%65536;break;case 2:this.registers.AC=this.read(this.registers.AR);break;case 3:this.write(this.registers.AR,this.registers.AC);break;case 4:this.registers.PC=this.registers.AR;break;case 5:this.write(this.registers.AR++,this.registers.PC),this.registers.PC=this.registers.AR;break;case 6:this.registers.DR=this.read(this.registers.AR),this.registers.DR=(this.registers.DR+1)%65536,this.write(this.registers.AR,this.registers.DR),0===this.registers.DR&&this.registers.PC++}}};const h=e=>{const t=new Blob([e],{type:"application/octet-stream"}),s=window.URL.createObjectURL(t),i=document.createElement("a");i.style="display:none;",i.href=s,i.download=`mano-rom-${Date.now()}.bin`,i.click(),setTimeout((()=>{i.remove(),window.URL.revokeObjectURL(s)}),100)};n.onOutput(t.addText.bind(t)),e.onInput(n.getInput.bind(n)),document.getElementById("assemble").addEventListener("click",(e=>{e.target.disabled=!0,document.getElementById("execute").style="",document.getElementById("download").style="",document.getElementById("reload").style="",document.querySelector("select").disabled=!0,e.preventDefault();const t=document.querySelector("textarea").value,s=r.assemble(t);n.setRam(s)})),document.getElementById("download").addEventListener("click",(e=>{h(n.ram)})),document.getElementById("reload").addEventListener("click",(e=>{window.location.reload()})),document.getElementById("execute").addEventListener("click",(e=>{e.target.disabled=!0,n.run()})),document.querySelector("select").addEventListener("change",(e=>{"custom"===e.target.value?(document.querySelector("textarea").value="",document.querySelector("textarea").readOnly=!1):fetch(e.target.value).then((e=>e.text())).then((e=>{document.querySelector("textarea").value=e,document.querySelector("textarea").readOnly=!0}))}));